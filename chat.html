<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatbot Thu√™ Xe Version 3.0</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }

.container{max-width:900px;margin:20px auto;padding:10px;background:#fff;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
h1,h2,h3{margin:0 0 10px 0;}
ul{padding-left:20px;}

/* Chatbot Icon */
#chatbotIcon {
  position: fixed; bottom:20px; left:20px;
  width:50px; height:50px;
  background:#00bcd4; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-size:24px; cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  z-index:9999; 
  /* Th√™m transition cho vi·ªác di chuy·ªÉn icon khi m·ªü/ƒë√≥ng */
  transition: all 0.4s cubic-bezier(0.4,0,0.2,1); 
}
#chatbotIcon:active { transform: scale(0.9); }

/* Chatbox */
#chatbot {
  position: fixed; bottom:20px; left:20px;
  width:320px; max-width:90%; height:450px;
  background:#fff; border-radius:15px;
  box-shadow:0 8px 30px rgba(0,0,0,0.25);
  display:flex; flex-direction:column;
  overflow:hidden; z-index:9998;
  transform: translateY(100%) scale(0.9);
  transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
}
#chatbot.show { transform: translateY(0) scale(1); }

/* Header */
#chatHeader { background:#00bcd4; color:#fff; padding:12px; font-weight:bold; display:flex; align-items:center; cursor:grab; }
#chatHeader img { width:35px; height:35px; border-radius:50%; margin-right:10px; border: 2px solid #fff; }
#closeChat { margin-left:auto; cursor:pointer; font-weight:bold; font-size:20px; opacity:0.8; transition: opacity 0.2s; }
#closeChat:hover { opacity:1; }

/* Messages */
#chatMessages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; background:#f9f9f9; }
.bot, .user { padding:10px 15px; margin:5px 0; border-radius:18px; max-width:80%; position:relative; line-height:1.4; }
.bot { background:#e0f7fa; align-self:flex-start; border-bottom-left-radius:5px; }
.user { background:#c8e6c9; align-self:flex-end; border-bottom-right-radius:5px; }

/* Quick Replies */
.quick-reply-container { margin-top: 10px; align-self: flex-start; max-width: 100%; display: flex; flex-wrap: wrap; }
.quick-reply-button {
    background: #00bcd4; color: #fff; border: none;
    padding: 8px 12px; margin: 3px;
    border-radius: 15px; cursor: pointer;
    font-size: 13px; transition: background-color 0.2s;
    display: inline-block;
}
.quick-reply-button:hover { background: #0097a7; }

/* Input */
#chatInput { display:flex; border-top:1px solid #eee; }
#chatInput input { flex:1; border:none; padding:12px; outline:none; font-size:14px; }
#chatInput button { padding:12px 15px; background:#00bcd4; color:#fff; border:none; cursor:pointer; transition: background-color 0.2s; }
#chatInput button:hover { background: #0097a7; }

/* Balloon Animation */
.ballon { position:absolute; font-size:20px; animation:fly 1s ease-out forwards; }
@keyframes fly {0%{opacity:1; transform:translateY(0);}100%{opacity:0; transform:translateY(-40px);}}
</style>
</head>
<body>

<div class="container">
  <h1>Cho Thu√™ Xe M√°y H√† N·ªôi (Chatbot V3.0)</h1>
  <p>D·ªãch v·ª• thu√™ xe m√°y nhanh ch√≥ng, ti·ªán l·ª£i, uy t√≠n.</p>
  <h2>Danh s√°ch xe v√† gi√° tham kh·∫£o</h2>
  <ul>
    <li>Xe 50cc: 200k/ng√†y, 800k/tu·∫ßn, 1.8 tri·ªáu/th√°ng</li>
    <li>Xe s·ªë (Wave, Sirius): 150k/ng√†y, 600k/tu·∫ßn, 1.2 tri·ªáu/th√°ng</li>
    <li>Xe ga (Vision, Airblade): 200k/ng√†y, 900k/tu·∫ßn, 2 tri·ªáu/th√°ng</li>
    <li>Xe ƒëi·ªán: 200k/ng√†y, 800k/tu·∫ßn, 1.5 tri·ªáu/th√°ng</li>
  </ul>
</div>

<div id="chatbotIcon">üèçÔ∏è</div>
<div id="chatbot">
  <div id="chatHeader">
    <img id="botIcon" src="https://i.imgur.com/3cXnUuT.png" alt="Bot">
    Tr·ª£ l√Ω Thu√™ Xe
    <span id="closeChat">√ó</span>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input type="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button>G·ª≠i</button>
  </div>
</div>

<script>
const chatbot = document.getElementById('chatbot');
const chatbotIcon = document.getElementById('chatbotIcon');
const closeChat = document.getElementById('closeChat');
const messages = document.getElementById('chatMessages');
const input = document.querySelector('#chatInput input');
const button = document.querySelector('#chatInput button');
const botIcon = document.getElementById('botIcon');

const priceData = [
  { xe:"honda vision", day:200, week:900, month:2000, type:"xe ga" },
  { xe:"air blade", day:200, week:900, month:2000, type:"xe ga" },
  { xe:"xe ga", day:200, week:900, month:2000, type:"xe ga" },
  { xe:"wave", day:150, week:600, month:1200, type:"xe s·ªë" },
  { xe:"sirius", day:150, week:600, month:1200, type:"xe s·ªë" },
  { xe:"xe s·ªë", day:150, week:600, month:1200, type:"xe s·ªë" },
  { xe:"xe 50cc", day:200, week:800, month:1800, type:"xe 50cc" },
  { xe:"xe ƒëi·ªán", day:200, week:800, month:1500, type:"xe ƒëi·ªán" }
];

// Tr·∫°ng th√°i h·ªôi tho·∫°i
let chatState = {
    step: 'start', // 'start', 'asking_type', 'asking_duration'
    selectedType: null, // L∆∞u lo·∫°i xe (VD: 'xe ga')
    selectedXeName: null, // L∆∞u t√™n xe c·ª• th·ªÉ (VD: 'honda vision')
};

// ======================= UI/CORE FUNCTIONS =======================

// M·ªü/ƒë√≥ng chatbot
chatbotIcon.addEventListener('click', ()=>{
  chatbot.classList.add('show');
  // Di chuy·ªÉn icon v·ªÅ v·ªã tr√≠ c·ªë ƒë·ªãnh
  chatbotIcon.style.left = chatbot.style.left || '20px'; 
  chatbotIcon.style.bottom = chatbot.style.bottom || '20px';
  chatbotIcon.style.transform = 'scale(0)'; // ·∫®n icon khi chatbox m·ªü
  
  if (messages.children.length === 0) { // Ch·ªâ ch√†o l·∫ßn ƒë·∫ßu
      showBotMessage("Ch√†o b·∫°n! T√¥i l√† Tr·ª£ l√Ω Thu√™ Xe. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n ch·ªçn xe v√† t√≠nh gi√° thu√™ ngay l·∫≠p t·ª©c.", getStartQuickReplies());
  }
});

closeChat.addEventListener('click', ()=>{ 
  chatbot.classList.remove('show'); 
  // Hi·ªán l·∫°i icon
  chatbotIcon.style.transform = 'scale(1)'; 
});

function formatPrice(priceInK){
    if (priceInK === 0) return '0k';
    return priceInK >= 1000 ? (priceInK / 1000).toFixed(1).replace(/\.0$/, '') + " tri·ªáu" : priceInK + "k";
}

/**
 * Hi·ªÉn th·ªã tin nh·∫Øn bot v√† th√™m Quick Replies n·∫øu c√≥.
 * @param {string} msg - N·ªôi dung tin nh·∫Øn.
 * @param {Array|null} replies - M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng {text, value} cho Quick Replies.
 */
function showBotMessage(msg, replies = null){
  botIcon.style.transform="scaleY(0.1)";
  setTimeout(()=>{botIcon.style.transform="scaleY(1)";},150);

  const div=document.createElement('div');
  div.className='bot';
  div.innerHTML = msg;

  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;

  if(replies && replies.length > 0){
      const qrContainer = document.createElement('div');
      qrContainer.className = 'quick-reply-container';

      replies.forEach(reply => {
          const btn = document.createElement('button');
          btn.className = 'quick-reply-button';
          btn.textContent = reply.text;
          btn.setAttribute('data-value', reply.value);
          btn.onclick = () => {
              // G·ª≠i n·ªôi dung n√∫t nh∆∞ th·ªÉ ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p
              input.value = reply.value;
              handleInput();
          };
          qrContainer.appendChild(btn);
      });
      div.appendChild(qrContainer);
      messages.scrollTop = messages.scrollHeight;
  }

  // Hi·ªáu ·ª©ng bong b√≥ng üéâ
  const balloon=document.createElement('div');
  balloon.className='ballon';
  balloon.textContent="üõµüí®"; 
  balloon.style.left=Math.random()*80+"%";
  div.appendChild(balloon);
  setTimeout(()=>{div.removeChild(balloon);},1000);
}

// ======================= QUICK REPLY DATA =======================
function getStartQuickReplies() {
    return [
        { text: "Xem B·∫£ng Gi√°", value: "xem b·∫£ng gi√°" },
        { text: "Thu√™ Xe Ga", value: "thu√™ xe ga" },
        { text: "Thu√™ Xe S·ªë", value: "thu√™ xe s·ªë" },
    ];
}

function getDurationQuickReplies(type) {
    const base = type.includes('ga') ? 200 : 150; // Gi√° ∆∞·ªõc t√≠nh
    return [
        { text: `1 Ng√†y (${formatPrice(base)})`, value: `thu√™ ${type} 1 ng√†y` },
        { text: `1 Tu·∫ßn (${formatPrice(base * 7 * 0.5)})`, value: `thu√™ ${type} 1 tu·∫ßn` }, // Gi·∫£m gi√° 50% cho tu·∫ßn (gi·∫£ ƒë·ªãnh)
        { text: "1 Th√°ng", value: `thu√™ ${type} 1 th√°ng` },
    ];
}

// ======================= CONVERSATION LOGIC =======================

function handleInput(){
  const userMsg=input.value.trim().toLowerCase();
  if(!userMsg) return;

  // 1. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng v√† x√≥a input
  const userDiv=document.createElement('div');
  userDiv.className='user';
  userDiv.textContent=input.value.trim();
  messages.appendChild(userDiv);
  messages.scrollTop=messages.scrollHeight;
  input.value='';

  let found = false;

  // 2. Ph√¢n t√≠ch th√¥ng tin t·ª´ input
  let selectedXe = priceData.find(x => userMsg.includes(x.xe) || userMsg.includes(x.type));
  const regex = /(\d+)\s*(ng√†y|tu·∫ßn|th√°ng)/i;
  const match = userMsg.match(regex);
  let qty = match ? parseInt(match[1]) : 1;
  let type = match ? match[2] : null; // D√πng null ƒë·ªÉ ph√¢n bi·ªát ch∆∞a c√≥ th·ªùi gian

  // --- LOGIC B√ÅO GI√Å TR·ª∞C TI·∫æP ---
  if (selectedXe && type) {
      let price = 0;
      let unitPrice = 0;
      let durationUnit = type.slice(0, -1);

      if (type === "ng√†y") { price = selectedXe.day * qty; unitPrice = selectedXe.day; durationUnit = 'ng√†y'; }
      else if (type === "tu·∫ßn") { price = selectedXe.week * qty; unitPrice = selectedXe.week; durationUnit = 'tu·∫ßn'; }
      else if (type === "th√°ng") { price = selectedXe.month * qty; unitPrice = selectedXe.month; durationUnit = 'th√°ng'; }

      showBotMessage(`üí∞ Gi√° thu√™ **${selectedXe.xe}** trong ${qty} ${type} l√† **${formatPrice(price)}**. 
ƒê·ªÉ ƒë·∫∑t xe, vui l√≤ng li√™n h·ªá Hotline/Zalo **+84 912 345 678** ƒë·ªÉ x√°c nh·∫≠n!`);
      chatState.step = 'start'; // Reset tr·∫°ng th√°i
      found = true;
  } 
  
  // --- LOGIC CHUY·ªÇN TR·∫†NG TH√ÅI (State Transition) ---

  // T√¨nh hu·ªëng 1: Ng∆∞·ªùi d√πng ch·ªâ n√≥i lo·∫°i xe (ho·∫∑c click n√∫t xe)
  else if (selectedXe && !type) {
      chatState.selectedType = selectedXe.type;
      chatState.selectedXeName = selectedXe.xe;
      chatState.step = 'asking_duration';

      showBotMessage(`B·∫°n ƒë√£ ch·ªçn **${selectedXe.xe}**. B·∫°n mu·ªën thu√™ trong m·∫•y ng√†y, m·∫•y tu·∫ßn hay m·∫•y th√°ng?`, getDurationQuickReplies(selectedXe.type));
      found = true;
  }
  
  // T√¨nh hu·ªëng 2: Ng∆∞·ªùi d√πng ch·ªâ n√≥i th·ªùi gian thu√™ (VD: "thu√™ 2 ng√†y")
  else if (type && !selectedXe && chatState.step !== 'asking_type') {
      showBotMessage(`B·∫°n mu·ªën thu√™ trong **${qty} ${type}** nh∆∞ng ch∆∞a ch·ªçn lo·∫°i xe. B·∫°n mu·ªën thu√™ xe **ga**, **xe s·ªë**, **50cc** hay **xe ƒëi·ªán**?`);
      chatState.step = 'asking_type';
      found = true;
  }
  
  // T√¨nh hu·ªëng 3: Ng∆∞·ªùi d√πng nh·∫≠p t√™n xe sau khi bot h·ªèi lo·∫°i xe (Chuy·ªÉn t·ª´ step asking_type)
  else if (chatState.step === 'asking_type' && selectedXe) {
      // ƒê√£ nh·∫≠n di·ªán ƒë∆∞·ª£c xe, ti·∫øp t·ª•c h·ªèi th·ªùi gian
      chatState.selectedType = selectedXe.type;
      chatState.selectedXeName = selectedXe.xe;
      chatState.step = 'asking_duration';
      showBotMessage(`Tuy·ªát v·ªùi! B·∫°n ƒë√£ ch·ªçn **${selectedXe.xe}**. Thu√™ trong m·∫•y ng√†y, tu·∫ßn, hay th√°ng?`, getDurationQuickReplies(selectedXe.type));
      found = true;
  }

  // --- LOGIC C√ÇU H·ªéI CHUNG ---
  if (!found) {
    if (userMsg.includes("b·∫£ng gi√°") || userMsg.includes("gi√°")) {
        let priceMsg = "ƒê√¢y l√† b·∫£ng gi√° tham kh·∫£o c√°c lo·∫°i xe ph·ªï bi·∫øn:\n";
        priceData.filter(x => x.xe.includes('ga') || x.xe.includes('s·ªë') || x.xe.includes('50cc')).forEach(x => {
            priceMsg += `- **${x.xe}**: ${formatPrice(x.day)}/ng√†y\n`;
        });
        showBotMessage(priceMsg.replace(/\n/g, '<br>'));
        chatState.step = 'start';
    } else if (userMsg.includes("xin ch√†o") || userMsg.includes("hello") || userMsg.includes("hi")){
        showBotMessage("Ch√†o b·∫°n! T√¥i l√† Tr·ª£ l√Ω Thu√™ Xe. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?", getStartQuickReplies());
    } else {
        showBotMessage("T√¥i xin l·ªói, t√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi n√†y üòÖ. B·∫°n vui l√≤ng h·ªèi v·ªÅ **gi√° xe**, **thu√™ xe** ho·∫∑c **b·∫£ng gi√°** nh√©!");
    }
  }
}

button.addEventListener('click', handleInput);
input.addEventListener('keydown',(e)=>{if(e.key==='Enter') handleInput();});


// ======================= K√©o th·∫£ Chatbot (Drag Functionality) =======================
let isDragging=false, offsetX=0, offsetY=0;
const header=document.getElementById('chatHeader');

header.addEventListener('mousedown', startDrag);
header.addEventListener('touchstart', startDrag);

function startDrag(e){
  e.preventDefault(); isDragging=true;
  const rect=chatbot.getBoundingClientRect();
  
  if(e.type==='touchstart'){
    offsetX=e.touches[0].clientX-rect.left;
    offsetY=e.touches[0].clientY-rect.top;
  } else {
    offsetX=e.clientX-rect.left;
    offsetY=e.clientY-rect.top;
  }
  
  // Quan tr·ªçng: Ph·∫£i chuy·ªÉn v·ªã tr√≠ icon sang absolute/fixed khi k√©o
  chatbot.style.position = 'fixed'; 
  chatbot.style.bottom = 'auto';
  chatbot.style.left = rect.left + 'px';
  chatbot.style.top = rect.top + 'px';

  document.addEventListener('mousemove', dragMove);
  document.addEventListener('mouseup', stopDrag);
  document.addEventListener('touchmove', dragMove, {passive: false});
  document.addEventListener('touchend', stopDrag);
}

function dragMove(e){
  if(!isDragging) return;
  
  let x, y;
  if(e.type.startsWith('touch')){
    e.preventDefault();
    x=e.touches[0].clientX-offsetX;
    y=e.touches[0].clientY-offsetY;
  } else {
    x=e.clientX-offsetX;
    y=e.clientY-offsetY;
  }
  
  const maxX=window.innerWidth-chatbot.offsetWidth;
  const maxY=window.innerHeight-chatbot.offsetHeight;
  
  chatbot.style.left=Math.min(Math.max(0,x),maxX)+'px';
  chatbot.style.top=Math.min(Math.max(0,y),maxY)+'px';
}

function stopDrag(){
  isDragging=false;
  document.removeEventListener('mousemove',dragMove);
  document.removeEventListener('mouseup',stopDrag);
  document.removeEventListener('touchmove',dragMove);
  document.removeEventListener('touchend',stopDrag);
}
</script>
</body>
</html>
