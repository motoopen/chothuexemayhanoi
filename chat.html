<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatbot Thu√™ Xe Version 4.0</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; }

.container{max-width:900px;margin:20px auto;padding:10px;background:#fff;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
h1,h2,h3{margin:0 0 10px 0;}
ul{padding-left:20px;}

/* Chatbot Icon */
#chatbotIcon {
  position: fixed; bottom:20px; left:20px;
  width:50px; height:50px;
  background:#1a73e8; /* M√†u xanh Google/Modern */
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-size:24px; cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  z-index:9999; 
  transition: transform 0.3s ease-out, background-color 0.2s;
}
#chatbotIcon:hover { background-color: #0d47a1; }

/* Chatbox */
#chatbot {
  position: fixed; bottom:20px; left:20px;
  width:320px; max-width:90%; height:450px;
  background:#fff; border-radius:15px;
  box-shadow:0 8px 30px rgba(0,0,0,0.25);
  display:flex; flex-direction:column;
  overflow:hidden; z-index:9998;
  transform: translateY(100%) scale(0.9);
  transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
}
#chatbot.show { 
  transform: translateY(0) scale(1); 
  /* T·ªëi ∆∞u v·ªã tr√≠ icon khi chatbox m·ªü */
  left: 20px; 
  bottom: 20px;
}

/* Header */
#chatHeader { background:#1a73e8; color:#fff; padding:12px; font-weight:bold; display:flex; align-items:center; cursor:grab; }
#chatHeader img { width:35px; height:35px; border-radius:50%; margin-right:10px; border: 2px solid #fff; }
#closeChat { margin-left:auto; cursor:pointer; font-weight:bold; font-size:20px; opacity:0.8; transition: opacity 0.2s; }
#closeChat:hover { opacity:1; }

/* Messages */
#chatMessages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; background:#f9f9f9; }
.bot, .user { padding:10px 15px; margin:5px 0; border-radius:18px; max-width:80%; position:relative; line-height:1.4; }
.bot { background:#e8f0fe; align-self:flex-start; border-bottom-left-radius:5px; color: #1f1f1f; }
.user { background:#dcf8c6; align-self:flex-end; border-bottom-right-radius:5px; color: #1f1f1f; }

/* Quick Replies */
.quick-reply-container { margin-top: 10px; align-self: flex-start; max-width: 100%; display: flex; flex-wrap: wrap; }
.quick-reply-button {
    background: #1a73e8; color: #fff; border: none;
    padding: 8px 12px; margin: 3px;
    border-radius: 20px; cursor: pointer;
    font-size: 13px; transition: background-color 0.2s;
    display: inline-block;
}
.quick-reply-button:hover { background: #0d47a1; }

/* Input */
#chatInput { display:flex; border-top:1px solid #eee; padding: 5px; }
#chatInput input { flex:1; border:none; padding:10px; outline:none; font-size:14px; border-radius: 20px; background: #f0f0f0; margin-right: 5px; }
#chatInput button { 
  width: 40px; height: 40px; padding: 0; 
  background:#1a73e8; color:#fff; border:none; 
  border-radius: 50%; cursor:pointer; 
  transition: background-color 0.2s; font-size: 16px;
  display: flex; align-items: center; justify-content: center;
}
#chatInput button:hover { background: #0d47a1; }
.mic-button { background: #fff !important; color: #1a73e8 !important; margin-right: 5px; }

/* Balloon Animation */
.ballon { position:absolute; font-size:20px; animation:fly 1s ease-out forwards; }
@keyframes fly {0%{opacity:1; transform:translateY(0);}100%{opacity:0; transform:translateY(-40px);}}
</style>
</head>
<body>

<div class="container">
  <h1>Cho Thu√™ Xe M√°y H√† N·ªôi (Chatbot V4.0)</h1>
  <p>D·ªãch v·ª• thu√™ xe m√°y nhanh ch√≥ng, ti·ªán l·ª£i, uy t√≠n.</p>
  <h2>Danh s√°ch xe v√† gi√° tham kh·∫£o</h2>
  <ul>
    <li>Xe 50cc: 200k/ng√†y, 800k/tu·∫ßn, 1.8 tri·ªáu/th√°ng</li>
    <li>Xe s·ªë (Wave, Sirius): 150k/ng√†y, 600k/tu·∫ßn, 1.2 tri·ªáu/th√°ng</li>
    <li>Xe ga (Vision, Airblade): 200k/ng√†y, 900k/tu·∫ßn, 2 tri·ªáu/th√°ng</li>
    <li>Xe ƒëi·ªán: 200k/ng√†y, 800k/tu·∫ßn, 1.5 tri·ªáu/th√°ng</li>
  </ul>
</div>

<div id="chatbotIcon"><i class="fas fa-motorcycle"></i></div>
<div id="chatbot">
  <div id="chatHeader">
    <img id="botIcon" src="https://i.imgur.com/3cXnUuT.png" alt="Bot">
    Tr·ª£ l√Ω Thu√™ Xe
    <span id="closeChat">√ó</span>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInput">
    <button class="mic-button"><i class="fas fa-microphone"></i></button>
    <input type="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
    <button><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<script>
// DOM
const chatbot = document.getElementById('chatbot');
const chatbotIcon = document.getElementById('chatbotIcon');
const closeChat = document.getElementById('closeChat');
const messages = document.getElementById('chatMessages');
const input = document.querySelector('#chatInput input');
const button = document.querySelector('#chatInput button:last-child'); // N√∫t G·ª≠i
const micButton = document.querySelector('#chatInput button:first-child'); // N√∫t Mic
const botIcon = document.getElementById('botIcon');

// D·ªØ li·ªáu xe
const priceData = [
  { xe:"honda vision", day:200, week:900, month:2000, type:"xe ga" },
  { xe:"air blade", day:200, week:900, month:2000, type:"xe ga" },
  { xe:"xe ga", day:200, week:900, month:2000, type:"xe ga" }, // Gi√° ƒë·∫°i di·ªán
  { xe:"wave", day:150, week:600, month:1200, type:"xe s·ªë" },
  { xe:"sirius", day:150, week:600, month:1200, type:"xe s·ªë" },
  { xe:"xe s·ªë", day:150, week:600, month:1200, type:"xe s·ªë" }, // Gi√° ƒë·∫°i di·ªán
  { xe:"xe 50cc", day:200, week:800, month:1800, type:"xe 50cc" },
  { xe:"xe ƒëi·ªán", day:200, week:800, month:1500, type:"xe ƒëi·ªán" }
];

// Tr·∫°ng th√°i
let chatState = { 
    step:'start', // 'start', 'asking_type', 'asking_duration'
    selectedType:null, 
    selectedXeName:null,
    tempDuration: null // D√πng ƒë·ªÉ l∆∞u th·ªùi gian n·∫øu ng∆∞·ªùi d√πng nh·∫≠p tr∆∞·ªõc lo·∫°i xe
};

// ======================= M·ªü/ƒë√≥ng Chatbot =======================
chatbotIcon.addEventListener('click', ()=>{
  chatbot.classList.add('show');
  chatbotIcon.style.transform='scale(0)'; // ·∫®n icon khi m·ªü

  if(messages.children.length===0){
      showBotMessage("Xin ch√†o! T√¥i l√† Tr·ª£ l√Ω Thu√™ Xe ü§ñ. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n ch·ªçn xe v√† b√°o gi√° thu√™ ngay l·∫≠p t·ª©c.", getStartQuickReplies());
  }
});

closeChat.addEventListener('click', ()=>{
  chatbot.classList.remove('show');
  chatbotIcon.style.transform='scale(1)'; // Hi·ªán icon khi ƒë√≥ng
});

// Gi·∫£ l·∫≠p n√∫t Mic (Ch·ª©c nƒÉng kh√¥ng ƒë∆∞·ª£c tri·ªÉn khai th·ª±c t·∫ø)
micButton.addEventListener('click', () => {
    showBotMessage("T√≠nh nƒÉng ghi √¢m/gi·ªçng n√≥i ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn, b·∫°n vui l√≤ng nh·∫≠p tin nh·∫Øn nh√©! üòä");
});

// ======================= H√†m hi·ªÉn th·ªã tin nh·∫Øn =======================
function formatPrice(priceInK){
    if (priceInK === 0) return '0k';
    return priceInK >= 1000 ? (priceInK / 1000).toFixed(1).replace(/\.0$/, '') + " tri·ªáu" : priceInK + "k";
}

function showBotMessage(msg, replies = null){
  // Hi·ªáu ·ª©ng icon bot
  botIcon.style.transform="scaleY(0.1)";
  setTimeout(()=>{botIcon.style.transform="scaleY(1)";},150);

  const div=document.createElement('div');
  div.className='bot';
  div.innerHTML=msg;
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;

  // Th√™m Quick Replies
  if(replies && replies.length>0){
      const qrContainer=document.createElement('div');
      qrContainer.className='quick-reply-container';
      replies.forEach(r=>{
          const btn=document.createElement('button');
          btn.className='quick-reply-button';
          btn.textContent=r.text;
          btn.onclick=()=>{
              input.value=r.value; 
              handleInput();
          }
          qrContainer.appendChild(btn);
      });
      div.appendChild(qrContainer);
      messages.scrollTop=messages.scrollHeight;
  }

  // Hi·ªáu ·ª©ng bong b√≥ng
  const balloon=document.createElement('div');
  balloon.className='ballon';
  balloon.textContent="üõµüí®";
  balloon.style.left=Math.random()*80+"%";
  div.appendChild(balloon);
  setTimeout(()=>{div.removeChild(balloon);},1000);
}

// ======================= Quick Replies =======================
function getStartQuickReplies(){
    return [
        {text:"Xem B·∫£ng Gi√°",value:"xem b·∫£ng gi√°"},
        {text:"Thu√™ Xe Ga",value:"thu√™ xe ga"},
        {text:"Thu√™ Xe S·ªë",value:"thu√™ xe s·ªë"}
    ];
}

function getDurationQuickReplies(type){
    // L·∫•y gi√° c∆° b·∫£n cho lo·∫°i xe
    const xeBase = priceData.find(x => x.type === type) || { day: 200, week: 900, month: 2000 };
    return [
        {text:`1 Ng√†y (${formatPrice(xeBase.day)})`,value:`thu√™ ${type} 1 ng√†y`},
        {text:`1 Tu·∫ßn (${formatPrice(xeBase.week)})`,value:`thu√™ ${type} 1 tu·∫ßn`},
        {text:`1 Th√°ng (${formatPrice(xeBase.month)})`,value:`thu√™ ${type} 1 th√°ng`}
    ];
}

function getVehicleTypeQuickReplies(duration = null){
    // N·∫øu c√≥ th·ªùi gian tempDuration, th√™m v√†o c√¢u tr·∫£ l·ªùi
    const durationText = duration ? ` trong ${duration.qty} ${duration.type}` : '';
    return [
        {text:`Xe Ga${durationText}`,value:`thu√™ xe ga ${durationText}`},
        {text:`Xe S·ªë${durationText}`,value:`thu√™ xe s·ªë ${durationText}`},
        {text:`Xe 50cc${durationText}`,value:`thu√™ xe 50cc ${durationText}`},
    ];
}

// ======================= X·ª≠ l√Ω Input (Conversation Logic) =======================
function handleInput(){
    const userMsg = input.value.trim().toLowerCase();
    if(!userMsg) return;

    // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
    const userDiv = document.createElement('div');
    userDiv.className = 'user';
    userDiv.textContent = input.value.trim();
    messages.appendChild(userDiv);
    messages.scrollTop = messages.scrollHeight;
    input.value='';

    let found = false;

    // Ph√¢n t√≠ch th√¥ng tin t·ª´ input
    let selectedXe = priceData.find(x => userMsg.includes(x.xe) || userMsg.includes(x.type));
    const regex = /(\d+)\s*(ng√†y|tu·∫ßn|th√°ng)/i;
    const match = userMsg.match(regex);
    let qty = match ? parseInt(match[1]) : 1;
    let type = match ? match[2] : null;

    // --- LOGIC B√ÅO GI√Å TR·ª∞C TI·∫æP (Xe + Th·ªùi gian) ---
    if(selectedXe && type){
        let price = 0;
        if(type==='ng√†y') price=selectedXe.day*qty;
        else if(type==='tu·∫ßn') price=selectedXe.week*qty;
        else if(type==='th√°ng') price=selectedXe.month*qty;

        showBotMessage(`üéâ Ho√†n t·∫•t b√°o gi√°! Xe **${selectedXe.xe}** thu√™ ${qty} ${type} c√≥ gi√° **${formatPrice(price)}** (VND).
Vui l√≤ng li√™n h·ªá Hotline/Zalo **+84 912 345 678** ƒë·ªÉ gi·ªØ xe v√† nh·∫≠n ∆∞u ƒë√£i!`);
        chatState.step='start';
        chatState.tempDuration = null; // X√≥a th·ªùi gian t·∫°m
        found=true;
    }
    // --- LOGIC CHUY·ªÇN TR·∫†NG TH√ÅI ---
    
    // T√¨nh hu·ªëng 1: Ng∆∞·ªùi d√πng ch·ªâ n√≥i lo·∫°i xe (ho·∫∑c click n√∫t xe)
    else if(selectedXe && !type){
        chatState.selectedType = selectedXe.type;
        chatState.selectedXeName = selectedXe.xe;
        chatState.step='asking_duration';

        showBotMessage(`Tuy·ªát v·ªùi! B·∫°n ch·ªçn **${selectedXe.xe}**. B·∫°n mu·ªën thu√™ trong m·∫•y ng√†y, m·∫•y tu·∫ßn hay m·∫•y th√°ng?`, getDurationQuickReplies(selectedXe.type));
        found=true;
    }
    
    // T√¨nh hu·ªëng 2: Ng∆∞·ªùi d√πng ch·ªâ n√≥i th·ªùi gian thu√™ (VD: "thu√™ 2 ng√†y")
    else if(type && !selectedXe){
        chatState.tempDuration = { qty: qty, type: type }; // L∆∞u th·ªùi gian t·∫°m
        chatState.step='asking_type';
        showBotMessage(`B·∫°n mu·ªën thu√™ trong **${qty} ${type}** nh∆∞ng ch∆∞a ch·ªçn lo·∫°i xe. B·∫°n mu·ªën thu√™ xe **ga**, **xe s·ªë**, **50cc** hay **xe ƒëi·ªán**?`, getVehicleTypeQuickReplies(chatState.tempDuration));
        found=true;
    }
    
    // T√¨nh hu·ªëng 3: Ng∆∞·ªùi d√πng nh·∫≠p lo·∫°i xe sau khi bot h·ªèi (D√πng th·ªùi gian t·∫°m)
    else if(chatState.step==='asking_type' && selectedXe && chatState.tempDuration){
        // Sau khi ch·ªçn xe, l·∫≠p t·ª©c b√°o gi√° k·∫øt h·ª£p v·ªõi tempDuration
        input.value = `thu√™ ${selectedXe.xe} ${chatState.tempDuration.qty} ${chatState.tempDuration.type}`;
        chatState.tempDuration = null; // X√≥a th·ªùi gian t·∫°m
        handleInput(); // Ch·∫°y l·∫°i ƒë·ªÉ x·ª≠ l√Ω b√°o gi√°
        found=true;
    }

    // --- C√¢u h·ªèi chung ---
    if(!found){
        if(userMsg.includes("b·∫£ng gi√°") || userMsg.includes("gi√°")){
            let priceMsg = "ƒê√¢y l√† b·∫£ng gi√° tham kh·∫£o c√°c lo·∫°i xe ph·ªï bi·∫øn:\n";
            priceData.filter(x=>['ga','s·ªë','50cc','ƒëi·ªán'].some(k=>x.xe.includes(k))).forEach(x=>{
                priceMsg += `- **${x.xe}**: ${formatPrice(x.day)}/ng√†y, ${formatPrice(x.week)}/tu·∫ßn, ${formatPrice(x.month)}/th√°ng<br>`;
            });
            showBotMessage(priceMsg, getStartQuickReplies());
            chatState.step='start';
        }
        else if(userMsg.includes("xin ch√†o") || userMsg.includes("hello") || userMsg.includes("hi")){
            showBotMessage("Ch√†o b·∫°n! T√¥i l√† Tr·ª£ l√Ω Thu√™ Xe. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?", getStartQuickReplies());
        } 
        else if(userMsg.includes("c·∫£m ∆°n")){
            showBotMessage("R·∫•t vui ƒë∆∞·ª£c ph·ª•c v·ª• b·∫°n! Ch√∫c b·∫°n c√≥ chuy·∫øn ƒëi an to√†n v√† th√∫ v·ªã. üòä");
            chatState.step='start';
        }
        else {
            showBotMessage("T√¥i xin l·ªói, t√¥i ch∆∞a hi·ªÉu. Vui l√≤ng h·ªèi v·ªÅ **gi√° xe**, **thu√™ xe** ho·∫∑c **b·∫£ng gi√°** nh√©!");
        }
    }
}

button.addEventListener('click', handleInput);
input.addEventListener('keydown', e=>{if(e.key==='Enter') handleInput();});

// ======================= K√©o th·∫£ Chatbot =======================
let isDragging=false, offsetX=0, offsetY=0;
const header=document.getElementById('chatHeader');
header.addEventListener('mousedown', startDrag);
header.addEventListener('touchstart', startDrag);

function startDrag(e){
    e.preventDefault(); isDragging=true;
    const rect=chatbot.getBoundingClientRect();
    if(e.type==='touchstart'){ offsetX=e.touches[0].clientX-rect.left; offsetY=e.touches[0].clientY-rect.top; }
    else{ offsetX=e.clientX-rect.left; offsetY=e.clientY-rect.top; }
    chatbot.style.position='fixed'; chatbot.style.bottom='auto'; chatbot.style.left=rect.left+'px'; chatbot.style.top=rect.top+'px';
    document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchmove', dragMove, {passive:false}); document.addEventListener('touchend', stopDrag);
}

function dragMove(e){
    if(!isDragging) return;
    let x,y;
    if(e.type.startsWith('touch')){ e.preventDefault(); x=e.touches[0].clientX-offsetX; y=e.touches[0].clientY-offsetY; }
    else{ x=e.clientX-offsetX; y=e.clientY-offsetY; }
    const maxX=window.innerWidth-chatbot.offsetWidth;
    const maxY=window.innerHeight-chatbot.offsetHeight;
    chatbot.style.left=Math.min(Math.max(0,x),maxX)+'px';
    chatbot.style.top=Math.min(Math.max(0,y),maxY)+'px';
}

function stopDrag(){ 
    isDragging=false; 
    document.removeEventListener('mousemove',dragMove); 
    document.removeEventListener('mouseup',stopDrag);
    document.removeEventListener('touchmove',dragMove); 
    document.removeEventListener('touchend',stopDrag);
}
</script>
</body>
</html>
