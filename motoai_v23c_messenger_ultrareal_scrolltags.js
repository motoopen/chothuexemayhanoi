/* motoai_v23c_messenger_ultrareal_scrolltags.js
   Messenger-style ~95% ‚Ä¢ Scrollable Tag Bar ‚Ä¢ SmartCalc ‚Ä¢ UltraSafe ‚Ä¢ iOS Fixes
   Brand: Motoopen | Zalo/Phone: 0857255868 | Map: https://maps.app.goo.gl/2icTBTxAToyvKTE78
   
   --- PHI√äN B·∫¢N ƒê√É FIX UX (ƒê√ìNG/M·ªû M∆Ø·ª¢T + TAG BAR ·ªîN ƒê·ªäNH) ---
*/
(function(){
  if(window.MotoAI_v23c_MESSENGER_LOADED) return;
  window.MotoAI_v23c_MESSENGER_LOADED = true;

  // ===== Config (c√≥ th·ªÉ override b·∫±ng window.MotoAI_CONFIG tr∆∞·ªõc khi nh√∫ng)
  const DEF = {
    brand: "Motoopen",
    phone: "0857255868",
    zalo:  "https://zalo.me/0857255868",
    map:   "https://maps.app.goo.gl/2icTBTxAToyvKTE78",
    minSentenceLen: 24
  };
  const ORG = (window.MotoAI_CONFIG||{});
  if(!ORG.zalo && (ORG.phone||DEF.phone)) ORG.zalo = 'https://zalo.me/' + String(ORG.phone||DEF.phone).replace(/\s+/g,'');
  const CFG = Object.assign({}, DEF, ORG);

  // ===== Utils
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const safe = s => { try{return JSON.parse(s)}catch(e){return null} };
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const pick  = a => a[Math.floor(Math.random()*a.length)];
  const nfVND = n => (n||0).toLocaleString('vi-VN');
  const IS_IOS = /iP(ad|hone|od)/.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);

  // ===== UI ‚Äî Messenger 95% + Tag bar k√©o ngang
  const ui = `
  <div id="mta-root" aria-live="polite">
    <button id="mta-bubble" aria-label="M·ªü chat" title="Chat">
      <svg viewBox="0 0 64 64" width="28" height="28" aria-hidden="true">
        <defs><linearGradient id="mtaG" x1="0" x2="1"><stop offset="0%" stop-color="#0084FF"/><stop offset="100%" stop-color="#00B2FF"/></linearGradient></defs>
        <circle cx="32" cy="32" r="28" fill="url(#mtaG)"></circle>
        <path d="M20 36l9-11 6 6 9-9-9 14-6-6-9 6z" fill="#fff"></path>
      </svg>
    </button>
    <div id="mta-backdrop"></div>
    <section id="mta-card" role="dialog" aria-label="Chat MotoAI" aria-hidden="true">
      <header id="mta-header">
        <div class="brand">
          <div class="left">
            <span class="avatar">üí¨</span>
            <div class="info">
              <div class="name">Nh√¢n vi√™n ${CFG.brand}</div>
              <div class="sub">ƒêang ho·∫°t ƒë·ªông üü¢</div>
            </div>
          </div>
          <nav class="quick">
            <a class="q q-phone" href="tel:${CFG.phone}" title="G·ªçi">üìû</a>
            <a class="q q-zalo"  href="${CFG.zalo}" target="_blank" rel="noopener" title="Zalo">Z</a>
            <a class="q q-map"   href="${CFG.map}" target="_blank" rel="noopener" title="B·∫£n ƒë·ªì">üìç</a>
          </nav>
          <button id="mta-close" title="ƒê√≥ng" aria-label="ƒê√≥ng">‚úï</button>
        </div>
      </header>
      <main id="mta-body"></main>

      <div id="mta-tags" role="toolbar" aria-label="G·ª£i √Ω nhanh (k√©o ngang)">
        <div class="tag-track" id="tagTrack">
          <button data-q="Xe s·ªë">üèçÔ∏è Xe s·ªë</button>
          <button data-q="Xe ga">üõµ Xe ga</button>
          <button data-q="Xe ƒëi·ªán">‚ö° Xe ƒëi·ªán</button>
          <button data-q="50cc">üö≤ 50cc</button>
          <button data-q="Xe c√¥n tay">üèçÔ∏è C√¥n tay</button>
          <button data-q="Th·ªß t·ª•c">üìÑ Th·ªß t·ª•c</button>
          <button data-q="B·∫£ng gi√°">üí∞ B·∫£ng gi√°</button>
          <button data-q="Li√™n h·ªá">‚òéÔ∏è Li√™n h·ªá</button>
        </div>
        <div class="fade fade-left"></div>
        <div class="fade fade-right"></div>
      </div>

      <footer id="mta-input">
        <input id="mta-in" placeholder="Nh·∫Øn tin cho ${CFG.brand}..." autocomplete="off" />
        <button id="mta-send" aria-label="G·ª≠i" title="G·ª≠i">
          <span class="plane">‚û§</span>
        </button>
      </footer>
      <button id="mta-clear" title="X√≥a h·ªôi tho·∫°i" aria-label="X√≥a h·ªôi tho·∫°i">üóë</button>
    </section>
  </div>`;

  const css = `
  :root{--mta-z:2147483647;--m-blue:#0084FF;--m-blue2:#00B2FF;--m-bg:#fff;--m-text:#0b1220}
  #mta-root{position:fixed;right:16px;left:auto;bottom:calc(18px + env(safe-area-inset-bottom,0));z-index:var(--mta-z);font-family:-apple-system,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;transition:bottom .25s ease,right .25s ease;transform:translateZ(0)}
  #mta-bubble{width:60px;height:60px;border:none;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 10px 26px rgba(0,0,0,.2);outline:3px solid #fff;will-change:transform}
  #mta-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:opacity .18s ease}
  #mta-backdrop.show{opacity:1;pointer-events:auto}
  
  /* === FIX UX 1 (CSS) === */
  #mta-card{
    position:fixed;right:16px;bottom:16px;width:min(420px,calc(100% - 24px));height:70vh;max-height:740px;background:var(--mta-bg);color:var(--mta-text);border-radius:18px;box-shadow:0 14px 40px rgba(0,0,0,.25);transform:translateY(110%);/* opacity:1 ƒë·ªÉ tr√°nh xung ƒë·ªôt transform+opacity tr√™n iOS */opacity:1;display:flex;flex-direction:column;overflow:hidden;
    /* ƒê√¢y l√† transition cho L√öC ƒê√ìNG (d√πng 'ease-in' - nhanh d·∫ßn) */
    transition: transform .22s cubic-bezier(0.64, 0, 0.78, 0); 
    will-change:transform
  }
  #mta-card.open{
    transform:translateY(0);
    /* ƒê√¢y l√† transition cho L√öC M·ªû (d√πng 'ease-out' - ch·∫≠m d·∫ßn) */
    transition: transform .25s cubic-bezier(0.22, 1, 0.36, 1);
  }
  /* === H·∫æT FIX UX 1 === */

  #mta-header{background:linear-gradient(90deg,var(--m-blue),var(--m-blue2));color:#fff}
  #mta-header .brand{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
  #mta-header .left{display:flex;align-items:center;gap:10px}
  .avatar{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify:content:center}
  .info .name{font-weight:800;line-height:1}
  .info .sub{font-size:12px;opacity:.95}
  .quick{display:flex;gap:6px;margin-left:auto;margin-right:6px}
  .q{width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;font-size:12px;font-weight:700;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25)}
  #mta-close{background:none;border:none;font-size:20px;color:#fff;cursor:pointer;opacity:.95}

  #mta-body{flex:1;overflow:auto;padding:14px 12px;background:#E9EEF5;-webkit-overflow-scrolling:touch}
  .m-msg{max-width:80%;margin:8px 0;padding:10px 13px;border-radius:20px;line-height:1.45;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .m-msg.bot{background:#fff;color:#111;border:1px solid rgba(0,0,0,.04)}
  .m-msg.user{background:#0084FF;color:#fff;margin-left:auto;border:1px solid rgba(0,0,0,.05)}
  #mta-typing{display:inline-flex;gap:6px;align-items:center}
  #mta-typing .dot{width:6px;height:6px;border-radius:50%;background:#555;opacity:.5;animation:blink 1s infinite}
  #mta-typing .dot:nth-child(2){animation-delay:.15s}
  #mta-typing .dot:nth-child(3){animation-delay:.3s}
  @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:.9}}

  /* Tag bar scrollable */
  #mta-tags{position:relative;background:#f7f9fc;border-top:1px solid rgba(0,0,0,.06)}
  #mta-tags .tag-track{display:block;overflow-x:auto;white-space:nowrap;padding:8px 10px 10px 10px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
  #mta-tags button{display:inline-block;margin-right:8px;padding:8px 12px;border:none;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.08);font-weight:600;cursor:pointer}
  #mta-tags button:active{transform:scale(.98)}
  #mta-tags .fade{position:absolute;top:0;bottom:0;width:22px;pointer-events:none;transition:opacity .18s ease}
  #mta-tags .fade-left{left:0;background:linear-gradient(90deg,#f7f9fc,rgba(247,249,252,0));opacity:0}
  #mta-tags .fade-right{right:0;background:linear-gradient(270deg,#f7f9fc,rgba(247,249,252,0));opacity:0}

  #mta-input{display:flex;gap:8px;padding:10px;background:#fff;border-top:1px solid rgba(0,0,0,.06)}
  #mta-in{flex:1;padding:11px 14px;border-radius:22px;border:1px solid rgba(0,0,0,.12);font-size:15px;background:#F6F8FB}
  #mta-send{width:42px;height:42px;border:none;border-radius:50%;background:linear-gradient(90deg,#0084FF,#00B2FF);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(0,132,255,.35)}
  #mta-clear{position:absolute;top:10px;right:48px;background:none;border:none;font-size:16px;color:#fff;opacity:.9;cursor:pointer}

  @media(max-width:520px){
    #mta-card{width:calc(100% - 16px);right:8px;left:8px;height:72vh}
    #mta-bubble{width:56px;height:56px}
  }
  @media(prefers-color-scheme:dark){
    :root{--m-bg:#1b1c1f;--m-text:#eaeef3}
    #mta-body{background:#1f2127}
    .m-msg.bot{background:#2a2d34;color:#eaeef3;border:1px solid rgba(255,255,255,.06)}
    #mta-tags{background:#1f2127;border-top:1px solid rgba(255,255,255,.08)}
    #mta-tags button{background:#2a2d34;color:#eaeef3;border:1px solid rgba(255,255,255,.10)}
    #mta-input{background:#202226;border-top:1px solid rgba(255,255,255,.08)}
    #mta-in{background:#16181c;color:#f0f3f7;border:1px solid rgba(255,255,255,.12)}
  }
  .ai-night #mta-bubble{box-shadow:0 0 18px rgba(0,132,255,.35)!important;}

  @media (prefers-reduced-motion: reduce){
    #mta-backdrop{transition:none}
    #mta-card{transition:none}
  }
  `;

  // ===== Inject
  function injectUI(){
    if($('#mta-root')) return;
    const wrap = document.createElement('div'); wrap.innerHTML = ui; document.body.appendChild(wrap.firstElementChild);
    const st = document.createElement('style'); st.textContent = css; document.head.appendChild(st);
  }
  function ready(fn){ if(document.readyState==="complete"||document.readyState==="interactive"){ fn(); } else document.addEventListener("DOMContentLoaded", fn); }

  // ===== State + Session
  let isOpen=false, sending=false, animating=false;
  const K = {sess:'MotoAI_v23c_session'};

  function addMsg(role,text){
    if(!text) return;
    const el = document.createElement('div'); el.className = 'm-msg '+(role==='user'?'user':'bot'); el.textContent = text;
    $('#mta-body').appendChild(el); $('#mta-body').scrollTop = $('#mta-body').scrollHeight;
    try{ const arr=safe(localStorage.getItem(K.sess))||[]; arr.push({role,text,t:Date.now()}); localStorage.setItem(K.sess, JSON.stringify(arr.slice(-200))); }catch(e){}
  }
  function renderSess(){
    const body=$('#mta-body'); body.innerHTML='';
    const arr=safe(localStorage.getItem(K.sess))||[];
    if(arr.length){ arr.forEach(m=> addMsg(m.role,m.text)); }
    else addMsg('bot', `Xin ch√†o üëã, em l√† nh√¢n vi√™n h·ªó tr·ª£ c·ªßa ${CFG.brand}. Anh/ch·ªã mu·ªën xem üèçÔ∏è Xe s·ªë, üõµ Xe ga, ‚ö° Xe ƒëi·ªán hay üìÑ Th·ªß t·ª•c thu√™ xe ·∫°?`);
  }

  // ===== Typing (3 dots)
  function showTyping(){
    const d=document.createElement('div'); d.id='mta-typing'; d.className='m-msg bot';
    d.innerHTML=`<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
    $('#mta-body').appendChild(d); $('#mta-body').scrollTop=$('#mta-body').scrollHeight;
  }
  function hideTyping(){ const d=$('#mta-typing'); if(d) d.remove(); }

  // ===== Polite & Rules
  const PREFIX = ["Ch√†o anh/ch·ªã,","Xin ch√†o üëã,","Em ch√†o anh/ch·ªã nh√©,","R·∫•t vui ƒë∆∞·ª£c h·ªó tr·ª£ anh/ch·ªã,"];
  const SUFFIX = [" ·∫°."," nh√© ·∫°."," nha anh/ch·ªã."," ·∫°, c·∫£m ∆°n anh/ch·ªã."];
  const pickText = t => (/[\.\!\?‚Ä¶]$/.test(t)?t:t+'.');
  function polite(t){ t=(t||"").trim(); if(!t) return "Em ch∆∞a nh·∫≠n ƒë∆∞·ª£c c√¢u h·ªèi, anh/ch·ªã th·ª≠ nh·∫≠p l·∫°i gi√∫p em nh√©."; return `${pick(PREFIX)} ${pickText(t)}${pick(SUFFIX)}`; }
  const RULES = [
    {re:/(ch√†o|xin ch√†o|hello|hi|alo)/i, ans:[
      `em l√† nh√¢n vi√™n h·ªó tr·ª£ c·ªßa ${CFG.brand}. Anh/ch·ªã mu·ªën xem üèçÔ∏è Xe s·ªë, üõµ Xe ga, ‚ö° Xe ƒëi·ªán hay üìÑ Th·ªß t·ª•c thu√™ xe ·∫°?`,
      "em c√≥ th·ªÉ b√°o gi√° nhanh ho·∫∑c h∆∞·ªõng d·∫´n th·ªß t·ª•c. Anh/ch·ªã ƒëang quan t√¢m lo·∫°i xe n√†o ·∫°?"
    ]},
    {re:/(th·ªß t·ª•c|thu tuc|giay to|gi·∫•y t·ªù|c·ªçc|ƒë·∫∑t c·ªçc)/i, ans:[
      "th·ªß t·ª•c g·ªçn: CCCD/h·ªô chi·∫øu + c·ªçc tu·ª≥ xe. C√≥ ph∆∞∆°ng √°n gi·∫£m c·ªçc khi ƒë·ªß gi·∫•y t·ªù.",
      "em c√≥ th·ªÉ g·ª≠i danh s√°ch gi·∫•y t·ªù c·∫ßn v√† c√°ch nh·∫≠n/tr·∫£ xe nh√©."
    ]},
    {re:/(li√™n h·ªá|lien he|zalo|hotline|sƒët|sdt|g·ªçi|dien thoai)/i, ans:[
      `anh/ch·ªã li√™n h·ªá nhanh qua Zalo ${CFG.phone} ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n tr·ª±c ti·∫øp nh√©.`,
      `n·∫øu c·∫ßn g·∫•p, anh/ch·ªã g·ªçi ${CFG.phone} ‚Äî b·ªçn em ph·∫£n h·ªìi ngay ·∫°.`
    ]}
  ];
  function rule(q){ for(const r of RULES){ if(r.re.test(q)) return polite(pick(r.ans)); } return null; }

  // ===== SmartCalc
  const PRICE_TABLE = {
    'xe s·ªë':      { day:[130000,150000], week:[600000], month:[1000000,1200000] },
    'air blade':  { day:[200000], week:[800000], month:[1400000] },
    'vision':     { day:[200000], week:[900000], month:[2000000] },
    'xe ƒëi·ªán':    { day:[200000], week:[800000], month:[1500000] },
    '50cc':       { day:[200000], week:[800000], month:[1800000] },
    'xe c√¥n tay': { day:[350000], week:[1200000], month:[2500000] },
    'xe gi√° r·∫ª':  { day:[100000], week:[500000], month:[900000] }
  };
  const CHEAP_KWS = /(r·∫ª|gi√° r·∫ª|r·∫ª nh·∫•t|b√¨nh d√¢n|sinh vi√™n|hssv|xe r·∫ª)/i;
  function detectType(t){
    const low=t.toLowerCase();
    if(CHEAP_KWS.test(low)) return 'xe gi√° r·∫ª';
    if(/air\s*blade|airblade|ab\b/.test(low)) return 'air blade';
    if(/\bvision\b/.test(low)) return 'vision';
    if(/c√¥n tay|tay c√¥n/.test(low)) return 'xe c√¥n tay';
    if(/xe ƒëi·ªán|vinfast|yadea|dibao|gogo/.test(low)) return 'xe ƒëi·ªán';
    if(/50cc|xe 50/.test(low)) return '50cc';
    if(/xe ga/.test(low)) return 'vision';
    if(/xe s·ªë|wave|blade|sirius|jupiter/.test(low)) return 'xe s·ªë';
    return null;
  }
  function detectSpan(t){ const low=t.toLowerCase(); if(/tu·∫ßn|tuan|week/.test(low)) return 'week'; if(/th√°ng|thang|month/.test(low)) return 'month'; return 'day'; }
  function detectQty(t){ const m=t.match(/(\d+)\s*(ng√†y|day|tu·∫ßn|tuan|week|th√°ng|thang|month)?/i); if(!m) return null; const n=parseInt(m[1],10); if(!n||n<=0) return null; let unit='day'; if(m[2]) unit=detectSpan(m[2]); return {n,unit}; }
  function formatRange(arr){ if(!arr||!arr.length) return null; return arr.length===1? nfVND(arr[0])+'ƒë' : nfVND(arr[0])+'‚Äì'+nfVND(arr[1])+'ƒë'; }
  function baseFor(type,unit){ const it=PRICE_TABLE[type]; if(!it) return null; const arr=it[unit]; if(!arr) return null; return arr[0]; }
  function summariseType(type){ const it=PRICE_TABLE[type]; if(!it) return ''; const d=formatRange(it.day), w=formatRange(it.week), m=formatRange(it.month); const bits=[]; if(d) bits.push(d+'/ng√†y'); if(w) bits.push(w+'/tu·∫ßn'); if(m) bits.push(m+'/th√°ng'); return bits.join(', '); }
  function estimatePrice(text){
    let type = detectType(text) || 'xe s·ªë';
    const qty = detectQty(text);
    if(!qty) return `Gi√° ${type} kho·∫£ng ${summariseType(type)}. Anh/ch·ªã c√≥ th·ªÉ li√™n h·ªá Zalo ${CFG.phone} ƒë·ªÉ xem xe v√† nh·∫≠n gi√° ch√≠nh x√°c nh·∫•t ·∫°.`;
    const unit=qty.unit, n=qty.n, base=baseFor(type,unit);
    if(!base) return `Gi√° theo ${unit} c·ªßa ${type} hi·ªán ch∆∞a c√≥ trong b·∫£ng. Anh/ch·ªã li√™n h·ªá Zalo ${CFG.phone} ƒë·ªÉ b√°o gi√° ch√≠nh x√°c gi√∫p em nh√©.`;
    const total=base*n, label=unit==='day'?`${n} ng√†y`:unit==='week'?`${n} tu·∫ßn`:`${n} th√°ng`;
    return `Gi√° d·ª± ki·∫øn thu√™ ${type} ${label} kho·∫£ng ${nfVND(total)}ƒë ·∫° (∆∞·ªõc t√≠nh). Anh/ch·ªã c√≥ th·ªÉ li√™n h·ªá Zalo ${CFG.phone} ƒë·ªÉ xem xe v√† nh·∫≠n gi√° ch√≠nh x√°c nh·∫•t ·∫°.`;
  }
  function compose(q){
    const m=(q||'').trim(); if(!m) return polite("anh/ch·ªã th·ª≠ ch·ªçn tag ph√≠a d∆∞·ªõi ho·∫∑c nh·∫≠p c√¢u h·ªèi gi√∫p em nh√©");
    const r1=rule(m); if(r1) return r1;
    if(/(gi√°|bao nhi√™u|t√≠nh ti·ªÅn|bao nhieu|bao nhi·ªÅu|cost|price|thu√™|thue)/i.test(m) || CHEAP_KWS.test(m)) return polite(estimatePrice(m));
    return polite("em ch∆∞a t√¨m ƒë∆∞·ª£c th√¥ng tin tr√πng kh·ªõp. Anh/ch·ªã n√≥i r√µ lo·∫°i xe ho·∫∑c th·ªùi gian thu√™ gi√∫p em v·ªõi ·∫°.");
  }

  // ===== Open/Close/Clear + iOS/Safari ultra-safe
  function forceReflow(el){ try{ void el.offsetHeight; }catch(e){} }

  // === T·ªêI ∆ØU TH√äM 1/3: Tag Fades ===
  // ƒê∆∞a h√†m n√†y ra ngo√†i scope c·ªßa bindTags ƒë·ªÉ d√πng chung
  function updateTagFades(){
    const track = $('#tagTrack'); if(!track) return;
    try { // Th√™m try/catch ƒë·ªÉ si√™u an to√†n
      const left = track.scrollLeft > 2;
      // D√πng > 3 ƒë·ªÉ x·ª≠ l√Ω sai s·ªë sub-pixel t·ªët h∆°n
      const right = (track.scrollWidth - track.clientWidth - track.scrollLeft) > 3; 
      const fl=$('.fade-left'), fr=$('.fade-right');
      if(fl) fl.style.opacity = left ? 1 : 0;
      if(fr) fr.style.opacity = right ? 1 : 0;
    } catch(e) {/*b·ªè qua l·ªói n·∫øu DOM ch∆∞a s·∫µn s√†ng*/}
  }

  function openChat(){
    if(isOpen || animating) return;
    animating = true;

    const card = $('#mta-card');
    const backdrop = $('#mta-backdrop');
    const bubble = $('#mta-bubble');

    // chu·∫©n b·ªã l·ªõp n·ªÅn an to√†n ƒë·ªÉ tr√°nh ‚Äúƒë∆°‚Äù
    backdrop.style.opacity = '0';
    backdrop.style.pointerEvents = 'auto';
    forceReflow(backdrop); // ƒë·∫£m b·∫£o frame t√°ch b·∫°ch

    // ·∫®n bubble b·∫±ng visibility ƒë·ªÉ tr√°nh layout gi·∫≠t
    bubble.style.visibility = 'hidden';
    bubble.style.pointerEvents = 'none';

    // Hi·ªÉn th·ªã card/backdrop theo 2 frame ƒë·ªÉ iOS kh√¥ng k·∫πt GPU
    requestAnimationFrame(()=>{
      backdrop.classList.add('show');
      requestAnimationFrame(()=>{
        card.classList.add('open');
        document.body.style.overflow='hidden';
        isOpen = true;
        animating = false;
        renderSess();
        
        // === T·ªêI ∆ØU TH√äM 2/3: Tag Fades ===
        // G·ªçi update m·ªói khi m·ªü chat, v√¨ clientWidth c√≥ th·ªÉ ƒë√£ thay ƒë·ªïi
        setTimeout(updateTagFades, 50); 
        
        // Kh√¥ng t·ª± focus tr√™n iOS ƒë·ªÉ tr√°nh keyboard lock
        if(!IS_IOS){
          setTimeout(()=>{ try{$('#mta-in').focus()}catch(e){} }, 140);
        }
      });
    });
  }

  function closeChat(){
    if(!isOpen || animating) return;
    animating = true;

    const card = $('#mta-card');
    const backdrop = $('#mta-backdrop');
    const bubble = $('#mta-bubble');

    try{$('#mta-in').blur();}catch(e){}

    // === FIX UX 2 (ƒê·ªíNG B·ªò) ===
    // K√≠ch ho·∫°t c·∫£ hai animation C√ôNG L√öC
    card.classList.remove('open');
    backdrop.classList.remove('show'); 
    // =========================

    const onDone = ()=>{
      // backdrop.classList.remove('show'); // <-- ƒê√É CHUY·ªÇN L√äN TR√äN
      backdrop.style.pointerEvents = 'none';
      bubble.style.visibility = 'visible';
      bubble.style.pointerEvents = 'auto';
      document.body.style.overflow='';
      isOpen=false; animating=false; hideTyping();
      card.removeEventListener('transitionend', onDone);
      // fallback timeout n·∫øu transitionend kh√¥ng b·∫Øn (Safari l·ªói)
      clearTimeout(fallback);
    };

    // khi card xong m·ªõi ·∫©n backdrop ‚Äî tr√°nh ‚Äúm·∫•t click‚Äù l·ªõp v√¥ h√¨nh
    card.addEventListener('transitionend', onDone);
    const fallback = setTimeout(onDone, 260); // ph√≤ng khi Safari kh√¥ng fire event
  }

  function clearChat(){
    try{ localStorage.removeItem(K.sess);}catch(e){}
    $('#mta-body').innerHTML=''; addMsg('bot', polite('ƒë√£ x√≥a h·ªôi tho·∫°i'));
  }

  // ===== Tag bar events
  function bindTags(){
    const track = $('#tagTrack'); if(!track) return;
    track.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=> sendUser(b.dataset.q));
    });
    
    // H√†m updateFade g·ªëc ƒë√£ ƒë∆∞·ª£c chuy·ªÉn ra ngo√†i
    
    // G·ªçi h√†m update m·ªõi
    track.addEventListener('scroll', updateTagFades, {passive:true});
    
    // === T·ªêI ∆ØU TH√äM 3/3: Tag Fades ===
    setTimeout(updateTagFades, 50); // Gi·ªØ l·∫°i cho l·∫ßn t·∫£i ƒë·∫ßu
    // Th√™m listener cho resize (quan tr·ªçng khi xoay m√†n h√¨nh)
    window.addEventListener('resize', updateTagFades, {passive:true});
  }

  // ===== Send + typing delay (2.5‚Äì5s)
  async function sendUser(text){
    if(sending) return; sending=true;
    addMsg('user', text);
    showTyping(); const typingDelay = 2500 + Math.random()*2500; await sleep(typingDelay);
    let ans; try{ ans = compose(text); }catch(e){ ans = null; }
    hideTyping(); addMsg('bot', ans || polite(`xin l·ªói, c√≥ l·ªói khi tr·∫£ l·ªùi. Anh/ch·ªã li√™n h·ªá Zalo ${CFG.phone} gi√∫p em nh√©.`));
    sending=false;
  }

  // ===== Auto-avoid obstacles (footer/quick-call/keyboard)
  function checkObstacles(){
    const root=$('#mta-root'); if(!root) return;
    const blockers = document.querySelector('.bottom-appbar, .quick-call, #quick-call');
    let bottom='calc(18px + env(safe-area-inset-bottom, 0))';
    if(blockers){
      const r=blockers.getBoundingClientRect(); const space = window.innerHeight - r.top;
      if(space < 120) bottom = (space + 70) + 'px';
    }
    if(window.visualViewport){
      const vv = window.visualViewport;
      if(vv.height < window.innerHeight - 120) bottom = '110px';
    }
    root.style.bottom = bottom; root.style.right='16px'; root.style.left='auto';
  }

  function fixSafariKeyboard(){
    const card = $('#mta-card');
    if(!card || !window.visualViewport) return;
    window.visualViewport.addEventListener('resize', ()=>{
      const vv = window.visualViewport;
      if(vv.height < window.innerHeight - 100){ card.style.transform='translateY(0)'; }
      else { card.style.transform = $('#mta-card').classList.contains('open') ? 'translateY(0)' : 'translateY(110%)'; }
    }, {passive:true});
  }

  // ===== Boot
  ready(()=>{
    const hour=new Date().getHours(); if(hour>19||hour<6) document.body.classList.add('ai-night');
    injectUI();
    bindTags(); // <-- bindTags b√¢y gi·ªù ƒë√£ ƒë∆∞·ª£c t·ªëi ∆∞u

    // Bind
    $('#mta-bubble').addEventListener('click', openChat, {passive:true});
    $('#mta-backdrop').addEventListener('click', closeChat, {passive:true});
    $('#mta-close').addEventListener('click', closeChat, {passive:true});
    $('#mta-clear').addEventListener('click', clearChat, {passive:true});
    $('#mta-send').addEventListener('click', ()=>{ const v=($('#mta-in').value||'').trim(); if(!v) return; $('#mta-in').value=''; sendUser(v); });
    $('#mta-in').addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); const v=($('#mta-in').value||'').trim(); if(!v) return; $('#mta-in').value=''; sendUser(v); }});

    // Auto-avoid & iOS
    checkObstacles();
    window.addEventListener('resize', checkObstacles, {passive:true});
    window.addEventListener('scroll', checkObstacles, {passive:true});
    if(window.visualViewport) window.visualViewport.addEventListener('resize', checkObstacles, {passive:true});
    fixSafariKeyboard();

    // Watchdog (n·∫øu v√¨ l√Ω do g√¨ ƒë√≥ bubble bi·∫øn m·∫•t, ch√®n l·∫°i UI)
    setTimeout(()=>{ if(!$('#mta-bubble')) injectUI(); }, 2500);

    console.log('%cMotoAI v23c Messenger UltraReal ‚Äî Active (UX Fix v2)','color:#0084FF;font-weight:bold;');
  });

  // ===== Expose (mini API)
  window.MotoAI_v23c_messenger = {
    open: ()=>{ try{openChat()}catch(e){} },
    close: ()=>{ try{closeChat()}catch(e){} }
  };
})();
